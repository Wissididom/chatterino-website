---
name: Cloudflare Logs

on:
  push:
    branches: ["master", "main"]
  pull_request:
    branches: ["master", "main"]

env:
  PROJECT_NAME: website

concurrency:
  group: cloudflare-logs-${{ github.ref }}
  cancel-in-progress: true

jobs:
  cloudflare-logs:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CF Pages
        id: cf-pages
        uses: Wissididom/cf-pages-await@fix-set-output-deprecation
        with:
          apiToken: ${{ secrets.CF_LOG_TOKEN  }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          project: ${{ env.PROJECT_NAME }}
      - name: Post Cloudflare Pages Logs
        run: |
          # Get deployment logs by deployment id (https://developers.cloudflare.com/api/operations/pages-deployment-get-deployment-logs)
          deployment_logs="$(curl -sL https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/pages/projects/chatterino-website/deployments/${{ steps.cf-pages.outputs.id }}/history/logs -H "Authorization: Bearer ${{ secrets.CF_LOG_TOKEN }}" | jq -r '.result.data | map(.line) | join("\n")')"
          echo "$deployment_logs"
